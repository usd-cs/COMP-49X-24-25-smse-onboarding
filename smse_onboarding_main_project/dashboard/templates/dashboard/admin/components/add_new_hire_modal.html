{% load static %}

<!-- Add New Hire Modal -->
<div class="modal fade" id="addNewHireModal" tabindex="-1" aria-labelledby="addNewHireModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="addNewHireModalLabel">Add Faculty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <ul class="nav nav-tabs" id="addFacultyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="manually-tab" data-bs-toggle="tab" data-bs-target="#manually" type="button" role="tab">Manually</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="import-csv-tab" data-bs-toggle="tab" data-bs-target="#import-csv" type="button" role="tab">Import CSV</button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="addFacultyTabContent">
                    <!-- Manual Entry Tab -->
                    <div class="tab-pane fade show active" id="manually" role="tabpanel">
                        <form id="addFacultyForm" method="POST" action="{% url 'dashboard:add_faculty' %}" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-6 pe-4">
                                    <h6 class="mb-3">Basic Information</h6>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="form-label small">First Name</label>
                                            <input type="text" class="form-control form-control-sm" id="first_name" name="first_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Last Name</label>
                                            <input type="text" class="form-control form-control-sm" id="last_name" name="last_name" required>
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <label class="form-label small">Email</label>
                                        <input type="email" class="form-control form-control-sm" id="email" name="email" required placeholder="Enter email address">
                                    </div>

                                    <div class="row g-2 mt-2">
                                        <div class="col-md-6">
                                            <label class="form-label small">Phone Number</label>
                                            <input type="tel" class="form-control form-control-sm" id="phone" name="phone" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Zoom Phone</label>
                                            <input type="tel" class="form-control form-control-sm" id="zoom_phone" name="zoom_phone">
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <label class="form-label small">Office Room</label>
                                        <input type="text" class="form-control form-control-sm" id="office_room" name="office_room" required>
                                    </div>

                                    <h6 class="mb-2 mt-4">Account Settings</h6>
                                    <div class="mt-2">
                                        <label class="form-label small">Username</label>
                                        <input type="text" class="form-control form-control-sm" id="username" name="username" required>
                                        <div class="form-text small">Letters, digits and @/./+/-/_ only</div>
                                    </div>

                                    <div class="mt-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="password_enabled" name="password_enabled" checked>
                                            <label class="form-check-label small" for="password_enabled">
                                                Enable password authentication
                                            </label>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">User Type</label>
                                            <select class="form-select form-select-sm" id="user_type" name="user_type">
                                                <option value="new_hire">New Hire</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                            <div class="form-text small">Select whether this user is a new hire or an admin</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-6 ps-4 border-start">
                                    <h6 class="mb-3">Position Details</h6>
                                    <div class="mt-2">
                                        <label class="form-label small">Job Role</label>
                                        <input type="text" class="form-control form-control-sm" id="job_role" name="job_role" required>
                                    </div>

                                    <div class="mt-2">
                                        <label class="form-label small">Department</label>
                                        <input type="text" class="form-control form-control-sm" id="engineering_dept" name="engineering_dept" required>
                                    </div>

                                    <div class="mt-2">
                                        <label class="form-label small">Hire Date</label>
                                        <div class="row g-2">
                                            <div class="col-md-7">
                                                <input type="date" class="form-control form-control-sm" id="hire_date" name="hire_date" required>
                                            </div>
                                            <div class="col-md-5">
                                                <input type="time" class="form-control form-control-sm" id="hire_time" name="hire_time" required>
                                            </div>
                                        </div>
                                    </div>

                                    <h6 class="mb-2 mt-4">Additional Information</h6>
                                    <div class="mt-2">
                                        <label class="form-label small">Bio</label>
                                        <textarea class="form-control form-control-sm" id="bio" name="bio" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Import CSV Tab -->
                    <div class="tab-pane fade" id="import-csv" role="tabpanel">
                        <form id="csvUploadForm" method="POST" action="{% url 'dashboard:import_faculty_csv' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="text-center py-4 border rounded">
                                <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                                <h5 class="mt-3">Drag and drop your CSV file here</h5>
                                <p class="text-muted small mb-2">or</p>
                                <label class="btn btn-outline-primary btn-sm" for="csvFile">
                                    Browse Files
                                    <input type="file" id="csvFile" name="csv_file" accept=".csv" class="d-none">
                                </label>
                                <p class="mt-3 mb-1 text-muted small">Supported format: CSV</p>
                                <p class="text-muted small">Required columns: username, first_name, last_name, email, job_role, engineering_dept, phone, office_room, hire_date</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-link btn-sm text-decoration-none" id="addAnother">Add another</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="addFacultyBtn">Add Faculty</button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Hire Modal Styles -->
<style>
.modal-dialog {
    max-width: 1000px !important;
    margin: 1.75rem auto;
}

.modal-content {
    background-color: #f8f9fa;
}

.modal-body {
    background-color: #fff;
}

.nav-tabs .nav-link {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.form-control-sm, .form-select-sm {
    height: calc(1.5em + 0.5rem + 2px);
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.form-control-sm:focus, .form-select-sm:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.input-group-text {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.border-start {
    border-left: 1px solid #dee2e6;
}

textarea.form-control-sm {
    height: auto;
}

.form-check-input {
    margin-top: 0.2rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.small {
    font-size: 0.875rem;
}

.form-text {
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .modal-dialog {
        max-width: 95% !important;
        margin: 1rem auto;
    }
    
    .col-md-6.ps-4.border-start {
        padding-left: 1rem !important;
        border-left: none !important;
        margin-top: 2rem;
    }
}
</style>

<!-- Add New Hire Modal Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addFacultyForm');
    const csvForm = document.getElementById('csvUploadForm');
    
    // Phone number formatting
    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    });

    // Username auto-generation from email
    const emailInput = document.getElementById('email');
    const usernameInput = document.getElementById('username');
    emailInput.addEventListener('input', function(e) {
        const email = e.target.value;
        const username = email.split('@')[0];
        usernameInput.value = username;
    });

    // CSV file handling
    const csvFile = document.getElementById('csvFile');
    csvFile.addEventListener('change', function(e) {
        if (e.target.files[0]) {
            csvForm.submit();
        }
    });

    // Add Faculty button click handler
    document.getElementById('addFacultyBtn').addEventListener('click', function() {
        const activeTab = document.querySelector('.tab-pane.active');
        
        if (activeTab.id === 'manually') {
            // Basic form validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Create FormData object
            const formData = new FormData(form);
            
            // Get user type and set admin status
            const isAdmin = document.getElementById('user_type').value === 'admin';
            const passwordEnabled = document.getElementById('password_enabled').checked;
            
            // Ensure all form fields are included
            formData.set('first_name', document.getElementById('first_name').value);
            formData.set('last_name', document.getElementById('last_name').value);
            formData.set('email', document.getElementById('email').value);
            formData.set('phone', document.getElementById('phone').value);
            formData.set('zoom_phone', document.getElementById('zoom_phone').value);
            formData.set('office_room', document.getElementById('office_room').value);
            formData.set('username', document.getElementById('username').value);
            formData.set('job_role', document.getElementById('job_role').value);
            formData.set('engineering_dept', document.getElementById('engineering_dept').value);
            formData.set('hire_date', document.getElementById('hire_date').value);
            formData.set('hire_time', document.getElementById('hire_time').value);
            formData.set('bio', document.getElementById('bio').value);
            
            // Set admin-related fields
            formData.set('user_type', isAdmin ? 'admin' : 'new_hire');
            formData.set('password_enabled', passwordEnabled);
            formData.set('is_active', 'true');

            // Submit form using fetch
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form');
            });
        } else if (activeTab.id === 'import-csv') {
            if (!csvFile.files[0]) {
                alert('Please select a CSV file first');
                return;
            }
            csvForm.submit();
        }
    });

    // Reset form when modal is hidden
    const modal = document.getElementById('addNewHireModal');
    modal.addEventListener('hidden.bs.modal', function () {
        form.reset();
        csvForm.reset();
    });

    // Set default dates
    const now = new Date();
    document.getElementById('hire_date').valueAsDate = now;
    document.getElementById('hire_time').value = now.toTimeString().slice(0,5);
});
</script> 