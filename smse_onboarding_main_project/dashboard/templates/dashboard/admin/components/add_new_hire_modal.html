{% load static %}

<!-- Add New Hire Modal -->
<div class="modal fade" id="addNewHireModal" tabindex="-1" aria-labelledby="addNewHireModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNewHireModalLabel">Add Faculty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Add error alert div -->
                <div class="alert alert-danger d-none" id="errorAlert" role="alert"></div>
                <form id="basicInfoForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                                <div class="form-text">Username will be generated from email address</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" required pattern="^[\w.@+-]+$" readonly>
                                <div class="form-text">Auto-generated from email. Only letters, digits, and @/./+/-/_ allowed.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="department" name="department" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Job Role</label>
                                <input type="text" class="form-control" id="job_role" name="job_role" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Office Room</label>
                                <input type="text" class="form-control" id="office_room" name="office_room" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hire Date</label>
                                <input type="date" class="form-control" id="hire_date" name="hire_date" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitBtn">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            User created successfully!
        </div>
    </div>
</div>

<!-- Error Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-circle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="errorToastBody">
            An error occurred.
        </div>
    </div>
</div>

<!-- Add New Hire Modal Styles -->
<style>
.modal-dialog {
    max-width: 800px !important;
}

.modal-content {
    border-radius: 8px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-label {
    font-size: 14px;
    font-weight: 500;
    color: #212529;
}

.form-control {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
}

.form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
}

.btn {
    font-size: 14px;
    padding: 8px 16px;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 16px 24px;
}

.alert {
    margin-bottom: 1rem;
    font-size: 14px;
}

.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c2c7;
    color: #842029;
}

.form-text {
    font-size: 12px;
    color: #6c757d;
    margin-top: 0.25rem;
}

input[readonly] {
    background-color: #e9ecef;
    cursor: not-allowed;
}

.toast {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    min-width: 300px;
}

.toast-header {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}

.toast-body {
    padding: 12px 16px;
    font-size: 14px;
}
</style>

<!-- Add New Hire Modal Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Add New Hire Modal...');
    
    const submitBtn = document.getElementById('submitBtn');
    const addNewHireModal = document.getElementById('addNewHireModal');
    const bsAddNewHireModal = new bootstrap.Modal(addNewHireModal);
    const emailInput = document.getElementById('email');
    const usernameInput = document.getElementById('username');
    const errorAlert = document.getElementById('errorAlert');
    const form = document.getElementById('basicInfoForm');
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

    console.log('All elements initialized:', {
        submitBtn: !!submitBtn,
        addNewHireModal: !!addNewHireModal,
        emailInput: !!emailInput,
        usernameInput: !!usernameInput,
        errorAlert: !!errorAlert,
        form: !!form,
        successToast: !!successToast,
        errorToast: !!errorToast
    });

    // Function to generate valid username
    function generateUsername(email) {
        // Remove everything after @ and any invalid characters
        let username = email.split('@')[0]
            .replace(/[^\w.@+-]/g, '') // Remove any characters not allowed
            .toLowerCase(); // Convert to lowercase
        
        // Ensure username starts with a letter
        if (!/^[a-z]/.test(username)) {
            username = 'user_' + username;
        }
        
        return username;
    }

    // Update username when email changes
    emailInput.addEventListener('input', function(e) {
        const email = e.target.value;
        if (email) {
            const username = generateUsername(email);
            usernameInput.value = username;
        } else {
            usernameInput.value = '';
        }
    });

    // Function to show error message
    function showError(message, details = null) {
        let errorHtml = `<strong>Error:</strong> ${message}`;
        if (details) {
            errorHtml += `<br><small>${details}</small>`;
        }
        errorAlert.innerHTML = errorHtml;
        errorAlert.classList.remove('d-none');
    }

    // Function to hide error message
    function hideError() {
        errorAlert.innerHTML = '';
        errorAlert.classList.add('d-none');
    }

    // Form validation and submission
    submitBtn.addEventListener('click', function() {
        console.log('Submit button clicked');
        hideError();
        
        if (!form.checkValidity()) {
            console.log('Form validation failed');
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        console.log('Form data prepared:', Object.fromEntries(formData));

        // Validate username format
        const username = usernameInput.value;
        if (!/^[\w.@+-]+$/.test(username)) {
            console.log('Username validation failed');
            document.getElementById('errorToastBody').textContent = 'Invalid username format. Username can only contain letters, digits, and @/./+/-/_';
            errorToast.show();
            return;
        }

        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';

        console.log('Submitting form...');
        fetch('{% url "dashboard:add_faculty" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Server response:', data);
            if (data.status === 'success') {
                console.log('User created successfully');
                // Show success toast
                successToast.show();
                
                // Hide the add new hire modal
                bsAddNewHireModal.hide();
                
                // Show the assign role modal with a small delay
                setTimeout(() => {
                    const assignRoleModal = document.getElementById('assignRoleModal');
                    console.log('Looking for assign role modal:', !!assignRoleModal);
                    if (assignRoleModal) {
                        try {
                            const bsAssignRoleModal = new bootstrap.Modal(assignRoleModal);
                            document.getElementById('userId').value = data.user_id;
                            bsAssignRoleModal.show();
                            console.log('Assign role modal shown successfully');
                        } catch (error) {
                            console.error('Error showing assign role modal:', error);
                            // Show error in toast
                            document.getElementById('errorToastBody').textContent = 'Error showing role assignment window. Please try again.';
                            errorToast.show();
                        }
                    } else {
                        console.error('Assign role modal not found in DOM');
                        // Show error in toast
                        document.getElementById('errorToastBody').textContent = 'Could not find role assignment window. Please refresh the page and try again.';
                        errorToast.show();
                    }
                }, 500);
            } else {
                console.log('Error from server:', data);
                // Show error in toast
                document.getElementById('errorToastBody').textContent = data.message || 'An error occurred while creating the user.';
                if (data.errors) {
                    if (data.errors.username) {
                        document.getElementById('errorToastBody').textContent = `Username error: ${data.errors.username.join(', ')}`;
                    } else {
                        const details = Object.entries(data.errors)
                            .map(([field, errors]) => `${field}: ${errors.join(', ')}`)
                            .join('\n');
                        document.getElementById('errorToastBody').textContent += `\n${details}`;
                    }
                }
                errorToast.show();
            }
        })
        .catch(error => {
            console.error('Network or parsing error:', error);
            // Show error in toast
            document.getElementById('errorToastBody').textContent = 'Network error. Please check your connection and try again.';
            errorToast.show();
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Create User';
        });
    });

    // Reset form when modal is hidden
    addNewHireModal.addEventListener('hidden.bs.modal', function () {
        console.log('Resetting form');
        form.reset();
        hideError();
        // Reset submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Create User';
    });

    // Clear error when user starts typing
    form.addEventListener('input', hideError);
});
</script>

{% include 'dashboard/admin/components/assign_role_modal.html' %} 